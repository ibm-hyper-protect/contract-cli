# Hyper Protect Contract CLI

## Introduction

The CLI has been developed to automate the process for generating contracts for provisioning Hyper Protect Virtual Servers for VPC and Hyper Protect Container Runtime.

## Prerequisites

### OPENSSL_BIN (optional)

You can configure the path to the `openssl` binary using the `OPENSSL_BIN` environment variable.

This is useful especially on systems where `openssl` is not available in the system `PATH` (e.g., on Windows).

#### Usage:

Set the `OPENSSL_BIN` environment variable to the full path of your `openssl` executable.

##### On Linux/macOS:

```bash
export OPENSSL_BIN=/usr/bin/openssl
```

##### On Windows:

On Windows (PowerShell):
```powershell
$env:OPENSSL_BIN="C:\Program Files\OpenSSL-Win64\bin\openssl.exe"
```

## Usage

### Base64

This feature will help customer to generate base64 of your plain text or JSON input.

```bash
$ contract-cli base64 --help
Generate base64 of input text

Usage:
  contract-cli base64 [flags]

Flags:
      --format string   Format of input data (options: text/json) (default "text")
  -h, --help            help for base64
      --in string       Input data that needs to be converted to string
      --out string      Path to store Base64 output
```

To generate base64 of plain text.
```bash
$ contract-cli base64 --in <input-text> --format plain
```

To generate base64 of JSON data.
```bash
$ contract-cli base64 --in <input-json-data> --format json
```

If you want to redirect the result to a file.
```bash
$ contract-cli base64 --in <input-text> --format plain --out <path-to-output-file>
```

The following is an example to generate base64.
```bash
$ contract-cli base64 --in sampleText --format plain # For plain text
$ contract-cli base64 --in {"type": "workload"} --format json # For JSON text
```


### base64-tgz

This feature will help customer to generate base64 tar tgz (plain or encrypted) of `docker-compose.yaml` or `pods.yaml`. The input is the path to the folder where the mentioned files are present.

```bash
$ contract-cli base64-tgz --help
Generate base64 tar.tgz of folder containing docker-compose.yaml or pods.yaml

Usage:
  contract-cli base64-tgz [flags]

Flags:
      --cert string     Path to encryption certificate
  -h, --help            help for base64-tgz
      --in string       Path to folder containing docker-compose.yaml or pods.yaml
      --os string       Hyper Protect OS version (hpvs/hpcr-rhvs)
      --out string      Path to store the encrypted or encrypted base64 tar tgz
      --output string   output format (unencrypted or encrypted) (default "plain")
```

To generate plain base64 tar tgz.
```bash
$ contract-cli base64-tgz --in <path-to-folder-of-yaml> 
```

To generate plain base64 tar tgz and redirect to a file.
```bash
$ contract-cli base64-tgz --in <path-to-folder-of-yaml> --out <path-to-output-file>
```

To generate encrypted tar tgz with the latest encryption certificate.
```bash
$ contract-cli base64-tgz --in <path-to-folder-of-yaml> --output encrypt
```

To generate encrypted tar tgz with custom encryption certificate.
```bash
$ contract-cli base64-tgz --in <path-to-folder-of-yaml> --output encrypt --cert <path-to-encryption-certificate>
```

To generate encrypted tar tgz for hpcr-rhvs.
```bash
$ contract-cli base64-tgz --in <path-to-folder-of-yaml> --output encrypt --os hpcr-rhvs
```

The following is an example to generate base64 tar tgz.
```bash
$ contract-cli base64-tgz --in pods # Generate base64 tar tgz
```


### decrypt-attestation

This features helps customer to decrypt encrypted attestation records.

```bash
$ contract-cli decrypt-attestation --help
Decrypt encrypted attestation record generated by HPVS/HPCR-RHVS under /var/hyperprotect/se-checksums.txt.enc

Usage:
  contract-cli decrypt-attestation [flags]

Flags:
  -h, --help          help for decrypt-attestation
      --in string     Path to file that stores encrypted attestation records (default "build/se-checksums.txt.enc")
      --out string    Path to save the decrypted attestation records
      --priv string   Path to private key
```

To decrypt an encrypted attestation records.
```bash
$ contract-cli decrypt-attestation --in <path_to_se-checksums.txt.enc> --priv <path_to_private_key>
```

To decrypt encrypted attestation and redirect the output to a file.
```bash
$ contract-cli decrypt-attestation --in <path_to_se-checksums.txt.enc> --priv <path_to_private_key> --out <path-to-output-file>
```

The following is an example to decrypt attestation records.
```bash
$ contract-cli decrypt-attestation --in se-checksums.txt.enc --priv private.pem
```


### download-certificate

This feature is used to download encryption certificate from IBM HPVS portal.

```bash
$ contract-cli download-certificate --help
Download encryption certificate for HPCR from IBM Hyper Protect Repository

Usage:
  contract-cli download-certificate [flags]

Flags:
      --format string     Format in which the data needs to STDOUT or saved in file (default "json")
  -h, --help              help for download-certificate
      --out string        Path to save the encryption certificates
      --version strings   Versions of Encryption Certificates to download, Seperated by coma(,)
```

To download a specific encryption certificate.
```bash
$ contract-cli download-certificate --version <hpcr-version-name>
```

To download an encryption certificate and save it to a file
```bash
$ contract-cli download-certificate --version <hpcr-version-name> --out <path-to-output-file>
```

The following is an example to download multiple encryption certificate.
```bash
$ contract-cli download-certificate --version 1.0.21,1.0.22,1.0.23
```


### encrypt

This feature is used to generate signed and encrypted contract.

```bash
$ contract-cli encrypt --help
Generate signed and encrypted contract

Usage:
  contract-cli encrypt [flags]

Flags:
      --cacert string     Path to CA Certificate
      --cakey string      Path to CA Key
      --cert string       Path to encryption certificate
      --contract-expiry   Boolean flag to enable contract expiry
      --csr string        Path to CSR file
      --csrParam string   Path to CSR details JSON file
      --expiry int        Expiry of the contract in number of days
  -h, --help              help for encrypt
      --in string         Path to contract
      --os string         Hyper Protect OS version (hpvs/hpcr-rhvs)
      --out string        Path to store signed and encrypted contract
      --priv string       Path to private key
```

To generate a signed and encrypted contract with latest encryption certificate.
```bash
$ contract-cli encrypt --in <path-to-contract> 
```

To generate a signed and encrypted with custom encryption certificate.
```bash
$ contract-cli encrypt --in <path-to-contract> --cert <path-to-encryption-certificate>
```

To generate a signed and encrypted contract with custom private key.
```bash
$ contract-cli encrypt --in <path-to-contract> --priv <path-to-private-key>
```

To generate a signed and encrypted contract with contract expiry.
```bash
$ contract-cli encrypt --contract-expiry --in <path-to-contract> --priv <path-to-private-key> --cacert <path-to-ca-cert> --cakey <path-to-ca-key> --csr <path-to-csr-path> --expiry <expiry-number>
```

The following is an example of generating signed and encrypted contract.
```bash
$ contract-cli encrypt --in samples/contract.yaml --priv samples/contract-expiry/private.pem # Generate signed and encrypted contract
$ contract-cli encrypt --contract-expiry --in samples/contract.yaml --priv samples/contract-expiry/private.pem --cacert samples/contract-expiry/personal_ca.crt --cakey samples/contract-expiry/personal_ca.pem --csr samples/contract-expiry/csr.pem --expiry 100 # Generate signed and encrypted contract with contract expiry
```


### encrypt-string

This feature will help to generate encrypted string.

```bash
$ contract-cli encrypt-string --help
Encrypt string in format hyper-protect-basic.<encrypted-password>.<encrypted-string>

Usage:
  contract-cli encrypt-string [flags]

Flags:
      --cert string     Path to encryption certificate
      --format string   The input string format (supported: text/json) (default "text")
  -h, --help            help for encrypt-string
      --in string       Data to encrypt
      --os string       Hyper Protect OS version (hpvs/hpcr-rhvs)
      --out string      Path to store the encrypted data
```

To generate an encrypted plain text with latest encryption certificate.
```bash
$ contract-cli encrypt-string --in <sample-string>
```

To generate and encrypted plain text and redirect the output to file.
```bash
$ contract-cli encrypt-string --in <sample-string> --out <path-to-output-file>
```

To generate an encrypted plain text with custom encryption certificate.
```bash
$ contract-cli encrypt-string --in <sample-string> --cert <path-to-encryption-certificate>
```

The following is an example to generate encrypted string.
```bash
$ contract-cli encrypt-string --in sample-workload # Generate encrypted string from plain text
$ contract-cli encrypt-string --in '{"type":"workload"}' --format json # Generate encrypt string from json input
```


### get-certificate

This feature will help users to select specific encryption certificate from JSON output of `contract-cli download-certificate`.

```bash
$ contract-cli get-certificate --help
Get version specific encryption certificate from JSON output of download-certificate

Usage:
  contract-cli get-certificate [flags]

Flags:
  -h, --help             help for get-certificate
      --in string        Path to the saved encryption certificates JSON
      --out string       Path to store the selected encryption certificate
      --version string   Encryption certificate version to select
```

To get a specific version.
```bash
$ contract-cli get-certificate --in <path-to-json-output-of-download-certificate> --version <version-number>
```

The following is an example to select encryption certificate.
```bash
$ contract-cli get-certificate --in samples/certificate/certs.json --version 1.0.21
```


### image

This feature helps to get Image details of specific version of latest version of HPVS on IBM Cloud from Terraform, CLI or API JSON output.

```bash
$ contract-cli image --help
Get latest HPCR image ID in IBM Cloud from IBM images JSON output from IBM Cloud API or CLI

Usage:
  contract-cli image [flags]

Flags:
      --format string    Format in which the data needs to STDOUT or saved in file (default "json")
  -h, --help             help for image
      --in string        Path to Terraform output or CLI or API result of image list
      --out string       Path to store HPCR image details
      --version string   Get IBM Cloud Image details of specified HPCR version
```

To get image details of latest HPVS image.

```bash
$ contract-cli image --in <path-to-json-file>
```

To get image details and store it in a file.
```bash
$ contract-cli image --in <path-to-json-file> --out <path-to-output-file>
```

To get image details in YAML format.
```bash
$ contract-cli image --in <path-to-json-file> --format yaml
```

The following is an example to get latest image details.
```bash
$ contract-cli image --in samples/images/terraform_image.json
```


### validate-contract

This feature will help to validate if the hyper protect contract is valid or not schematically.

```bash
$ contract-cli validate-contract --help                                    
Validate unencrypted contract with schema

Usage:
  contract-cli validate-contract [flags]

Flags:
  -h, --help        help for validate-contract
      --in string   Path to Hyper Protect encrypted contract contract
      --os string   Hyper Protect OS version (hpvs/hpcr-rhvs)
```

To validate a contract.
```bash
$ contract-cli validate-contract --in <path-to-contract>
```

The following is an example to validate a contract.
```bash
$ contract-cli validate-contract --in samples/contract.yaml
```
